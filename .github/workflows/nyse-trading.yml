name: NYSE Trading Sessions

on:
  schedule:
    # NYSE Morning Session - 10:00 AM EST (7:00 AM PST)
    # Runs at 15:00 UTC (10:00 AM EST) Monday-Friday
    - cron: '0 15 * * 1-5'

    # NYSE Midday Session - 12:30 PM EST (9:30 AM PST)
    # Runs at 17:30 UTC (12:30 PM EST) Monday-Friday
    - cron: '30 17 * * 1-5'

    # NYSE Afternoon Session - 3:00 PM EST (12:00 PM PST)
    # Runs at 20:00 UTC (3:00 PM EST) Monday-Friday
    - cron: '0 20 * * 1-5'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      time_of_day:
        description: 'Trading session (morning, midday, afternoon)'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - midday
          - afternoon

jobs:
  execute-nyse-trades:
    runs-on: ubuntu-latest
    steps:
      - name: Determine trading session
        id: session
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "time_of_day=${{ github.event.inputs.time_of_day }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" = "15" ]; then
              echo "time_of_day=morning" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "17" ]; then
              echo "time_of_day=midday" >> $GITHUB_OUTPUT
            else
              echo "time_of_day=afternoon" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Execute NYSE Trading
        run: |
          curl -X POST ${{ secrets.HEROKU_APP_URL }}/api/scheduled/execute-trades \
            -H "X-API-Key: ${{ secrets.SCHEDULER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"timezone\": \"America/New_York\", \"time_of_day\": \"${{ steps.session.outputs.time_of_day }}\"}" \
            -f -s -S -o response.json

          echo "Response:"
          cat response.json | jq '.'

      - name: Check execution status
        run: |
          STATUS=$(cat response.json | jq -r '.status')
          if [ "$STATUS" != "success" ]; then
            echo "Trading execution failed!"
            exit 1
          fi
          echo "Trading execution completed successfully"
