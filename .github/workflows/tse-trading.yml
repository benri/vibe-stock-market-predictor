name: TSE Trading Sessions

on:
  schedule:
    # TSE Morning Session - 9:30 AM JST
    # Runs at 00:30 UTC (9:30 AM JST) Monday-Friday
    - cron: '30 0 * * 1-5'

    # TSE Afternoon Session - 1:00 PM JST (after lunch break)
    # Runs at 04:00 UTC (1:00 PM JST) Monday-Friday
    - cron: '0 4 * * 1-5'

    # TSE Closing Session - 2:30 PM JST
    # Runs at 05:30 UTC (2:30 PM JST) Monday-Friday
    - cron: '30 5 * * 1-5'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      time_of_day:
        description: 'Trading session (morning, afternoon, closing)'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - afternoon
          - closing

jobs:
  execute-tse-trades:
    runs-on: ubuntu-latest
    steps:
      - name: Determine trading session
        id: session
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "time_of_day=${{ github.event.inputs.time_of_day }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            MINUTE=$(date -u +%M)
            if [ "$HOUR" = "00" ]; then
              echo "time_of_day=morning" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "04" ]; then
              echo "time_of_day=afternoon" >> $GITHUB_OUTPUT
            else
              echo "time_of_day=closing" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Execute TSE Trading
        run: |
          curl -X POST ${{ secrets.HEROKU_APP_URL }}/api/scheduled/execute-trades \
            -H "X-API-Key: ${{ secrets.SCHEDULER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"timezone\": \"Asia/Tokyo\", \"time_of_day\": \"${{ steps.session.outputs.time_of_day }}\"}" \
            -f -s -S -o response.json

          echo "Response:"
          cat response.json | jq '.'

      - name: Check execution status
        run: |
          STATUS=$(cat response.json | jq -r '.status')
          if [ "$STATUS" != "success" ]; then
            echo "Trading execution failed!"
            exit 1
          fi
          echo "Trading execution completed successfully"
